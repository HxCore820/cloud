name: ğŸ–¥ï¸ Windows RDP - CloudVPS

on: 
  workflow_dispatch:
    inputs:
      vps_id:
        description: 'VPS Request ID from Firebase'
        required: true
        type: string
      
      config:
        description: 'âš™ï¸ Cáº¥u hÃ¬nh VPS'
        required: true
        default: '4-8-all'
        type: choice
        options:
          - "2-4-2012"    # 2 CPU / 4 GB RAM - Win 2012 (50Ä‘/h)
          - "4-4-all"     # 4 CPU / 4 GB RAM - All Win (75Ä‘/h)
          - "4-8-all"     # 4 CPU / 8 GB RAM - All Win (100Ä‘/h)
          - "2-6-server"  # 2 CPU / 6 GB RAM - Win Server (60Ä‘/h)
          - "2-8-server"  # 2 CPU / 8 GB RAM - Win Server (80Ä‘/h)
          - "4-6-all"     # 4 CPU / 6 GB RAM - All Win (90Ä‘/h)
      
      os_version:
        description: 'ğŸ“€ Há»‡ Äiá»u HÃ nh'
        required: true
        default: '2025'
        type: choice
        options: 
          - "2025"
          - "2022"
          - "2019"
          - "2012"
          - "11"
          - "10"
      
      duration:
        description: 'â° Thá»i gian sá»­ dá»¥ng (giá»)'
        required: true
        default: '6'
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
          - "6"
      
      language:
        description: 'ğŸŒ NgÃ´n ngá»¯'
        required: true
        default: 'Tiáº¿ng Viá»‡t'
        type: choice
        options:
          - "English"
          - "Tiáº¿ng Viá»‡t"

jobs:
  validate-request:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      user_id: ${{ steps.validate.outputs.user_id }}
      
    steps:
      - name: ğŸ” Validate VPS Request
        id: validate
        run: |
          # This would validate against Firebase
          # Check if user has enough points
          # Check if user is not banned
          # For now, just pass
          echo "is_valid=true" >> $GITHUB_OUTPUT
          echo "user_id=demo_user" >> $GITHUB_OUTPUT

  windows-rdp:
    needs: validate-request
    if: needs.validate-request.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.duration) * 60 }}
    
    steps:
      - name: ğŸ”§ Parse Configuration
        id: config
        run: |
          CONFIG="${{ github.event.inputs.config }}"
          
          # Parse CPU and RAM from config
          if [[ "$CONFIG" == "2-4-2012" ]]; then
            CPU="2"
            RAM="4G"
          elif [[ "$CONFIG" == "4-4-all" ]]; then
            CPU="4"
            RAM="4G"
          elif [[ "$CONFIG" == "4-8-all" ]]; then
            CPU="4"
            RAM="8G"
          elif [[ "$CONFIG" == "2-6-server" ]]; then
            CPU="2"
            RAM="6G"
          elif [[ "$CONFIG" == "2-8-server" ]]; then
            CPU="2"
            RAM="8G"
          elif [[ "$CONFIG" == "4-6-all" ]]; then
            CPU="4"
            RAM="6G"
          fi
          
          echo "cpu=$CPU" >> $GITHUB_OUTPUT
          echo "ram=$RAM" >> $GITHUB_OUTPUT
          
          VERSION="${{ github.event.inputs.os_version }}"
          
          # Determine Windows Version name
          case "$VERSION" in
            "2025") OS_NAME="Windows Server 2025" ;;
            "2022") OS_NAME="Windows Server 2022" ;;
            "2019") OS_NAME="Windows Server 2019" ;;
            "2012") OS_NAME="Windows Server 2012" ;;
            "11") OS_NAME="Windows 11 Professional" ;;
            "10") OS_NAME="Windows 10 Professional" ;;
          esac
          
          echo "os_name=$OS_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ³ Setup Docker Windows
        run: |
          sudo apt-get update > /dev/null 2>&1
          
          CPU="${{ steps.config.outputs.cpu }}"
          RAM="${{ steps.config.outputs.ram }}"
          VERSION="${{ steps.config.outputs.version }}"
          
          # Create Docker Compose Configuration
          cat <<EOF > docker-compose.yml
          version: "3.9"
          services:
            windows:
              image: dockurr/windows
              container_name: cloudvps_rdp
              privileged: true
              environment:
                VERSION: "$VERSION"
                USERNAME: "CloudVPS"
                PASSWORD: "CloudVPS@2025"
                RAM_SIZE: "$RAM"
                CPU_CORES: "$CPU"
                DISK_SIZE: "60G"
              devices: [ "/dev/kvm" ]
              ports:
                - "3389:3389"
                - "8006:8006"
          EOF
          
          docker compose up -d > /dev/null 2>&1
          
          echo "OS_NAME=${{ steps.config.outputs.os_name }}" >> $GITHUB_ENV
          echo "CPU=$CPU" >> $GITHUB_ENV
          echo "RAM=$RAM" >> $GITHUB_ENV
          
          # Download Tunnel
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          
          # Start Tunnel for RDP
          nohup ./kami-tunnel 3389 > kami_tunnel_rdp.log 2>&1 &
          RDP_PID=$!
          echo "RDP_PID=$RDP_PID" >> $GITHUB_ENV
          
          sleep 5
          
          # Start Tunnel for Web Viewer
          nohup ./kami-tunnel 8006 > kami_tunnel_web.log 2>&1 &
          WEB_PID=$!
          echo "WEB_PID=$WEB_PID" >> $GITHUB_ENV

      - name: ğŸŒ Láº¥y ThÃ´ng Tin Káº¿t Ná»‘i
        id: connection
        run: |
          LANG="${{ github.event.inputs.language }}"
          
          # Get RDP IP
          RDP_PUBLIC_IP=""
          RDP_RETRY=0
          
          while [ -z "$RDP_PUBLIC_IP" ] && [ $RDP_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              RDP_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
              if [[ "$RDP_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
                RDP_PUBLIC_IP="$RDP_CONTENT"
                break
              fi
            fi
            sleep 3
            RDP_RETRY=$((RDP_RETRY + 1))
          done
          
          # Get Web IP
          WEB_PUBLIC_IP=""
          WEB_RETRY=0
          
          while [ -z "$WEB_PUBLIC_IP" ] && [ $WEB_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              WEB_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | tail -1)
              if [[ "$WEB_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]] && [ "$WEB_CONTENT" != "$RDP_PUBLIC_IP" ]; then
                WEB_PUBLIC_IP="$WEB_CONTENT"
                break
              fi
            fi
            sleep 3
            WEB_RETRY=$((WEB_RETRY + 1))
          done
          
          echo "rdp_ip=$RDP_PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "web_ip=$WEB_PUBLIC_IP" >> $GITHUB_OUTPUT
          
          # Display info
          echo ""
          if [ "$LANG" = "Tiáº¿ng Viá»‡t" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         âœ… $OS_NAME - Sáº´N SÃ€NG Káº¾T Ná»I (CloudVPS)"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸ–¥ï¸  Káº¾T Ná»I REMOTE DESKTOP (RDP)                                     â•‘"
            echo "â•‘  ğŸŒ  IP CÃ´ng khai   : $RDP_PUBLIC_IP"
            echo "â•‘  ğŸ‘¤  TÃ i khoáº£n      : CloudVPS                                        â•‘"
            echo "â•‘  ğŸ”  Máº­t kháº©u       : CloudVPS@2025                                   â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸŒ  TRÃŒNH XEM WEB                                                    â•‘"
            echo "â•‘  ğŸ”—  Äá»‹a chá»‰        : http://$WEB_PUBLIC_IP"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸ’»  TÃ€I NGUYÃŠN                                                       â•‘"
            echo "â•‘  âš¡  CPU            : $CPU vCPU                                       â•‘"
            echo "â•‘  ğŸ§   RAM            : $RAM                                            â•‘"
            echo "â•‘  ğŸ’¾  LÆ°u trá»¯        : 60GB                                            â•‘"
            echo "â•‘  â°  Thá»i gian      : ${{ github.event.inputs.duration }} giá»        â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         âœ… $OS_NAME - READY (CloudVPS)"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸ–¥ï¸  REMOTE DESKTOP (RDP)                                             â•‘"
            echo "â•‘  ğŸŒ  Public IP      : $RDP_PUBLIC_IP"
            echo "â•‘  ğŸ‘¤  Username       : CloudVPS                                        â•‘"
            echo "â•‘  ğŸ”  Password       : CloudVPS@2025                                   â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸŒ  WEB VIEWER                                                       â•‘"
            echo "â•‘  ğŸ”—  Address        : http://$WEB_PUBLIC_IP"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸ’»  RESOURCES                                                        â•‘"
            echo "â•‘  âš¡  CPU            : $CPU vCPU                                       â•‘"
            echo "â•‘  ğŸ§   RAM            : $RAM                                            â•‘"
            echo "â•‘  ğŸ’¾  Storage        : 60GB                                            â•‘"
            echo "â•‘  â°  Duration       : ${{ github.event.inputs.duration }} hours      â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: ğŸ“ Update Firebase
        run: |
          # This would update Firebase with connection info
          # Store RDP IP, Web IP, and status
          echo "VPS ID: ${{ github.event.inputs.vps_id }}"
          echo "RDP: ${{ steps.connection.outputs.rdp_ip }}"
          echo "Web: ${{ steps.connection.outputs.web_ip }}"
          echo "Status: active"

      - name: â° Session Keepalive
        run: |
          LANG="${{ github.event.inputs.language }}"
          DURATION_HOURS="${{ github.event.inputs.duration }}"
          END_TIME=$(($(date +%s) + $DURATION_HOURS * 3600))
          
          while [ $(date +%s) -lt $END_TIME ]; do
            REMAINING=$(( ($END_TIME - $(date +%s)) / 60 ))
            HOURS=$(($REMAINING / 60))
            MINUTES=$(($REMAINING % 60))
            
            if [ "$LANG" = "Tiáº¿ng Viá»‡t" ]; then
              echo -ne "\rğŸŸ¢ $OS_NAME Äang hoáº¡t Ä‘á»™ng | CÃ²n láº¡i: ${HOURS}h ${MINUTES}m | RDP: ${{ steps.connection.outputs.rdp_ip }}     "
            else
              echo -ne "\rğŸŸ¢ $OS_NAME Active | Remaining: ${HOURS}h ${MINUTES}m | RDP: ${{ steps.connection.outputs.rdp_ip }}     "
            fi
            
            sleep 30
          done
          
          echo ""
          if [ "$LANG" = "Tiáº¿ng Viá»‡t" ]; then
            echo "â° PhiÃªn VPS Ä‘Ã£ háº¿t háº¡n!"
          else
            echo "â° VPS session expired!"
          fi

      - name: ğŸ§¹ Cleanup & Update Status
        if: always()
        run: |
          # Update Firebase status to 'completed' or 'expired'
          echo "Cleaning up VPS ${{ github.event.inputs.vps_id }}"
          echo "Status: completed"
